<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} | Activités+</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/homepage.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

    <style>
        .dual-container {
            display: grid;
            grid-template-columns: 1fr 100px 1fr; /* Left, Operator, Right */
            gap: 20px;
            max-width: 1100px;
            margin: -60px auto 40px;
            position: relative;
            z-index: 10;
            align-items: start;
        }

        .entity-box {
            background: white; padding: 2rem; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-top: 5px solid #4361ee;
        }
        .entity-box.box-b { border-top-color: #f72585; }

        .operator-box {
            background: #2b2d42; color: white; padding: 20px 10px;
            border-radius: 15px; text-align: center;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 40px; /* Align visually with inputs */
        }

        .op-btn {
            background: transparent; border: 2px solid #555; color: #888;
            width: 50px; height: 50px; border-radius: 50%; margin: 0 auto;
            cursor: pointer; transition: 0.3s; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Radio button hidden logic */
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + label {
            background: #4cc9f0; color: #2b2d42; border-color: #4cc9f0; transform: scale(1.2);
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.5);
        }

        .form-label { font-weight: 800; display: block; margin-bottom: 10px; color: #555; text-transform: uppercase; font-size: 0.8rem; }
        .result-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .res-src-A { border-left-color: #4361ee; }
        .res-src-B { border-left-color: #f72585; }

        @media (max-width: 800px) {
            .dual-container { grid-template-columns: 1fr; }
            .operator-box { flex-direction: row; justify-content: center; margin-top: 0; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Activités<span>+</span></div>
        <ul class="nav-links"><li><a href="{{ url_for('admin_dashboard') }}">Dashboard</a></li></ul>
    </nav>

    <header class="page-header" style="min-height: 250px; background: linear-gradient(135deg, #0f172a, #334155);">
        <h1><i class="fas fa-project-diagram"></i> Recherche Relationnelle</h1>
        <p>Sélectionnez deux entités et définissez leur relation</p>
    </header>

    <form action="{{ url_for('recherche_relationnelle') }}" method="POST">
        <div class="dual-container">
            
            <div class="entity-box">
                <h3 style="color: #4361ee; margin-bottom: 20px;">ensemble A</h3>
                
                <span class="form-label">Type d'entité</span>
                <select name="entity_a" class="form-control" style="margin-bottom: 15px;">
                    <option value="etudiant" {% if entity_a == 'etudiant' %}selected{% endif %}>Étudiant</option>
                    <option value="club" {% if entity_a == 'club' %}selected{% endif %}>Club</option>
                    <option value="evenement" {% if entity_a == 'evenement' %}selected{% endif %}>Événement</option>
                </select>

                <span class="form-label">Critère (Filtre)</span>
                <input type="text" name="query_a" class="form-control" placeholder="Ex: Ali, Info..." value="{{ query_a }}">
            </div>

            <div class="operator-box">
                <div>
                    <input type="radio" id="op_union" name="operation" value="union" {% if operation == 'union' %}checked{% endif %}>
                    <label for="op_union" class="op-btn" title="Union (Tout afficher)"><i class="fas fa-layer-group"></i></label>
                    <small>Union</small>
                </div>
                <div>
                    <input type="radio" id="op_inter" name="operation" value="intersection" {% if operation == 'intersection' %}checked{% endif %}>
                    <label for="op_inter" class="op-btn" title="Intersection (Jointure)"><i class="fas fa-times"></i></label>
                    <small>Inter</small>
                </div>
                <div>
                    <input type="radio" id="op_diff" name="operation" value="difference" {% if operation == 'difference' %}checked{% endif %}>
                    <label for="op_diff" class="op-btn" title="Différence (A moins B)"><i class="fas fa-minus"></i></label>
                    <small>Diff</small>
                </div>
                
                <button type="submit" style="background:#10b981; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:10px;">GO</button>
            </div>

            <div class="entity-box box-b">
                <h3 style="color: #f72585; margin-bottom: 20px;">ensemble B</h3>
                
                <span class="form-label">Type d'entité</span>
                <select name="entity_b" class="form-control" style="margin-bottom: 15px;">
                    <option value="etudiant" {% if entity_b == 'etudiant' %}selected{% endif %}>Étudiant</option>
                    <option value="club" {% if entity_b == 'club' %}selected{% endif %}>Club</option>
                    <option value="evenement" {% if entity_b == 'evenement' %}selected{% endif %}>Événement</option>
                    <option value="sponsor" {% if entity_b == 'sponsor' %}selected{% endif %}>Sponsor</option>
                </select>

                <span class="form-label">Critère (Filtre)</span>
                <input type="text" name="query_b" class="form-control" placeholder="Ex: Robotique, 2024..." value="{{ query_b }}">
            </div>
        </div>
    </form>

    <div style="max-width: 800px; margin: 0 auto 50px; padding: 0 20px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}" style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if results %}
            <h3 style="margin-bottom: 20px; text-align: center;">{{ results|length }} Résultat(s)</h3>
            
            <div style="display: grid; gap: 10px;">
                {% for item in results %}
                    {% set obj = item.obj if operation == 'union' else item %}
                    {% set src = item.source if operation == 'union' else 'A' %}
                    
                    <div class="result-card res-src-{{ src }}">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>
                                    {% if obj.Nom %}{{ obj.Nom }} {{ obj.Prenom }}
                                    {% elif obj.NomClub %}{{ obj.NomClub }}
                                    {% elif obj.NomEvent %}{{ obj.NomEvent }}
                                    {% elif obj.NomSponsor %}{{ obj.NomSponsor }}
                                    {% else %}ID: {{ obj.id }}{% endif %}
                                </strong>
                                <br>
                                <small style="color: #666;">
                                    {% if obj.Filiere %}{{ obj.Filiere }}
                                    {% elif obj.TypeClub %}{{ obj.TypeClub }}
                                    {% elif obj.Theme %}{{ obj.Theme }}
                                    {% endif %}
                                </small>
                            </div>
                            
                            {% if operation == 'union' %}
                                <span style="font-size:0.8rem; font-weight:bold; color: #aaa;">Source {{ src }}</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif request.method == 'POST' %}
            <div style="text-align: center; color: #aaa; padding: 40px;">
                <i class="fas fa-wind" style="font-size: 3rem; margin-bottom: 10px;"></i>
                <p>Aucun résultat ne correspond à cette relation.</p>
            </div>
        {% endif %}
    </div>

</body>
</html>
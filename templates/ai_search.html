<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Search | Activités+</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/homepage.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #f72585;
            --bg-light: #f8f9fa;
        }
        body { background-color: var(--bg-light); font-family: 'Nunito Sans', sans-serif; }

        /* --- HEADER --- */
        .page-header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            padding: 120px 0 100px;
            text-align: center;
            color: white;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
        }
        .page-header h1 { font-family: 'Montserrat'; font-size: 2.5rem; margin-bottom: 10px; }
        .page-header p { font-size: 1.1rem; opacity: 0.8; }

        /* --- MAIN CONTAINER --- */
        .search-container { max-width: 900px; margin: -80px auto 40px; padding: 0 20px; position: relative; z-index: 10; }
        .search-panel { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }

        /* --- INPUT AREA --- */
        .input-group { position: relative; display: flex; gap: 10px; }
        .form-control { 
            width: 100%; padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 12px; 
            font-size: 1.1rem; font-family: inherit; transition: 0.3s; background: #fff; 
        }
        .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1); }

        .btn-ai { 
            background: linear-gradient(135deg, #f72585, #7209b7); color: white; border: none; 
            border-radius: 12px; padding: 0 30px; font-weight: 700; cursor: pointer; 
            transition: 0.3s; font-size: 1rem; display: flex; align-items: center; gap: 10px; 
        }
        .btn-ai:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(114, 9, 183, 0.3); }

        /* --- SUGGESTIONS --- */
        .suggestions { margin-top: 15px; font-size: 0.9rem; color: #6c757d; }
        .suggestion-chip { 
            cursor: pointer; color: var(--primary); font-weight: 600; 
            border-bottom: 1px dashed var(--primary); margin-right: 10px; transition: 0.2s; 
        }
        .suggestion-chip:hover { color: var(--secondary); border-bottom-style: solid; }

        /* --- RESULTS AREA --- */
        .results-area { margin-top: 30px; border-top: 1px solid #eee; padding-top: 30px; }
        
        .sql-box { 
            background: #1e1e2f; color: #a6e22e; padding: 15px; border-radius: 8px; 
            font-family: monospace; font-size: 0.9rem; margin-bottom: 20px; 
            display: none; position: relative; 
        }
        .sql-label { 
            position: absolute; top: -10px; left: 10px; background: #f72585; 
            color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; 
        }

        /* --- MODERN TABLE --- */
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
        .modern-table th { 
            text-align: left; padding: 12px; background: #f8f9fa; color: #6c757d; 
            font-size: 0.85rem; text-transform: uppercase; font-weight: 800; border-bottom: 2px solid #eee; 
        }
        .modern-table td { padding: 12px; border-bottom: 1px solid #f1f3f5; color: #2b2d42; }
        .modern-table tr:hover td { background: #fdfdfd; }

        /* --- LOADER --- */
        .loader { display: none; text-align: center; padding: 20px; }
        .spinner { 
            width: 40px; height: 40px; border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary); border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 0 auto 10px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-box { 
            background: #fee2e2; color: #ef4444; padding: 15px; border-radius: 8px; 
            display: none; margin-bottom: 20px; border: 1px solid #fecaca; 
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">Activités<span>+</span></div>
        <ul class="nav-links">
            <li><a href="{{ url_for('admin_dashboard') }}" class="active">Tableau de Bord</a></li>
            <li><a href="{{ url_for('logout') }}" style="color: var(--secondary); font-weight: 800;">Déconnexion</a>
            </li>
        </ul>
    </nav>

    <header class="page-header">
        <h1><i class="fas fa-robot"></i> Smart Search IA</h1>
        <p>Posez vos questions en langage naturel, Gemini s'occupe du SQL.</p>
    </header>

    <div class="search-container">
        <div class="search-panel">
            
            <label style="font-weight: 800; color: #2b2d42; display: block; margin-bottom: 10px;">Votre question :</label>
            <div class="input-group">
                <input type="text" id="userQuestion" class="form-control" 
                       placeholder="Ex: Liste des étudiants en Génie Info nés après 2002..." 
                       onkeypress="handleEnter(event)">
                <button class="btn-ai" onclick="sendRequest()">
                    <i class="fas fa-sparkles"></i> Analyser
                </button>
            </div>

            <div class="suggestions">
                <i class="far fa-lightbulb" style="color: #f72585;"></i> Essayez : 
                <span class="suggestion-chip" onclick="fillInput(this)">Quel club a le plus de membres ?</span>
                <span class="suggestion-chip" onclick="fillInput(this)">Total des contributions par sponsor</span>
                <span class="suggestion-chip" onclick="fillInput(this)">Liste des événements ce mois-ci</span>
            </div>

            <div id="loader" class="loader">
                <div class="spinner"></div>
                <p style="color: #666; font-size: 0.9rem;">L'IA analyse votre base de données...</p>
            </div>

            <div class="results-area">
                <div id="errorMessage" class="error-box"></div>

                <div id="sqlContainer" class="sql-box">
                    <span class="sql-label">SQL GÉNÉRÉ</span>
                    <div id="sqlOutput"></div>
                </div>

                <div id="tableContainer"></div>
            </div>

        </div>
    </div>

    <script>
        function handleEnter(e) {
            if (e.key === 'Enter') sendRequest();
        }

        function fillInput(el) {
            document.getElementById('userQuestion').value = el.innerText;
            // Optional: auto-send
            // sendRequest();
        }

        async function sendRequest() {
            const questionInput = document.getElementById('userQuestion');
            const question = questionInput.value.trim();
            
            // UI Elements
            const loader = document.getElementById('loader');
            const tableContainer = document.getElementById('tableContainer');
            const sqlContainer = document.getElementById('sqlContainer');
            const sqlOutput = document.getElementById('sqlOutput');
            const errorMsg = document.getElementById('errorMessage');

            if (!question) return;

            // Reset UI
            loader.style.display = 'block';
            tableContainer.innerHTML = '';
            sqlContainer.style.display = 'none';
            errorMsg.style.display = 'none';
            questionInput.disabled = true;

            try {
                // Ensure this route matches your Python Backend Route
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();

                if (data.status === 'error') {
                    errorMsg.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.message}`;
                    errorMsg.style.display = 'block';
                } else {
                    // Show SQL
                    sqlOutput.innerText = data.sql;
                    sqlContainer.style.display = 'block';

                    // Build Table
                    if (data.data.length === 0) {
                        tableContainer.innerHTML = `
                            <div style="text-align:center; padding: 40px; color: #aaa;">
                                <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                                Aucun résultat trouvé.
                            </div>`;
                    } else {
                        buildTable(data.headers, data.data, tableContainer);
                    }
                }

            } catch (err) {
                errorMsg.innerText = "Erreur de communication avec le serveur.";
                errorMsg.style.display = 'block';
                console.error(err);
            } finally {
                loader.style.display = 'none';
                questionInput.disabled = false;
                questionInput.focus();
            }
        }

        function buildTable(headers, rows, container) {
            let html = '<table class="modern-table"><thead><tr>';
            headers.forEach(h => { html += `<th>${h}</th>`; });
            html += '</tr></thead><tbody>';
            
            rows.forEach(row => {
                html += '<tr>';
                headers.forEach(h => {
                    let val = row[h] === null ? '<span style="color:#ccc">null</span>' : row[h];
                    html += `<td>${val}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            html += `<div style="text-align:right; margin-top:10px; color:#888; font-size:0.8rem;">${rows.length} résultats</div>`;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>